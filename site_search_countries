CREATE OR REPLACE TABLE `neogen-ga4-export.reporting_enterprise.site_search_daily_countries`
AS
WITH
  base_events AS (
    SELECT
      PARSE_DATE('%Y%m%d', _TABLE_SUFFIX) AS event_date,
      user_pseudo_id,
      CAST(
        (
          SELECT
            value.int_value
          FROM
            UNNEST(event_params)
          WHERE
            key = 'ga_session_id'
        ) AS STRING
      ) AS session_id,
      geo.country AS market_id,
      device.web_info.hostname AS hostname,
      (
        SELECT
          value.string_value
        FROM
          UNNEST(event_params)
        WHERE
          key = 'search_term'
      ) AS search_term,
      (
        SELECT
          value.string_value
        FROM
          UNNEST(event_params)
        WHERE
          key = 'page_location'
      ) AS page_location,
      event_name
    FROM
      `neogen-ga4-export.analytics_331328809.events_*`
    WHERE
      _TABLE_SUFFIX BETWEEN '20250101' AND FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY))
  ),
  search_sessions AS (
    SELECT DISTINCT
      event_date,
      user_pseudo_id,
      session_id,
      market_id,
      hostname,
      search_term,
      page_location
    FROM
      base_events
    WHERE
      event_name = 'view_search_results'
  ),
  pageview_events AS (
    SELECT
      event_date,
      user_pseudo_id,
      session_id,
      page_location
    FROM
      base_events
    WHERE
      event_name IN ('page_view', 'screen_view', 'view_item') -- adjust if you want only page_view
  ),
  -- Unique pageviews: one count per session_id + page_location
  unique_pageviews AS (
    SELECT
      event_date,
      page_location,
      COUNT(DISTINCT CONCAT(session_id, '_', page_location)) AS unique_pageviews
    FROM
      pageview_events
    GROUP BY
      event_date,
      page_location
  )
SELECT
  s.event_date AS date,
  COALESCE(s.market_id, 'Unknown') AS market_id,
  s.hostname,
  COALESCE(s.search_term, 'Not Set') AS search_term,
  s.page_location,
  COUNT(DISTINCT CONCAT(s.user_pseudo_id, '_', s.session_id)) AS sessions,
  COALESCE(u.unique_pageviews, 0) AS pageviews
FROM
  search_sessions AS s
  LEFT JOIN unique_pageviews AS u ON s.event_date = u.event_date AND s.page_location = u.page_location
GROUP BY
  date,
  market_id,
  hostname,
  search_term,
  page_location,
  pageviews
ORDER BY
  date DESC,
  sessions DESC;